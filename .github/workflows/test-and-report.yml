name: test-and-report

on:
  workflow_dispatch:
    inputs:
      node_versions:
        description: 'JSON list of Node.js versions'
        required: false
        default: '["22.x"]'
        type: string
      test_script:
        description: 'npm script to run tests'
        required: false
        default: 'test:github'
        type: string
      allure_version:
        description: 'Allure CLI version'
        required: false
        default: '2.34.0'
        type: string

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: ${{ fromJSON(inputs.node_versions) }}

    env:
      ALLURE_RESULTS_DIR: allure-results
      ALLURE_REPORT_DIR: allure-report
      TEST_SCRIPT: ${{ inputs.test_script }}
      FORCE_COLOR: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          # auto cache: pnpm > yarn > npm
          cache: ${{ hashFiles('pnpm-lock.yaml') != '' && 'pnpm' || (hashFiles('yarn.lock') != '' && 'yarn' || 'npm') }}

      - name: Enable Corepack
        run: corepack enable

      - name: Setup pnpm
        if: ${{ hashFiles('pnpm-lock.yaml') != '' }}
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies (pnpm)
        if: ${{ hashFiles('pnpm-lock.yaml') != '' }}
        run: pnpm install --frozen-lockfile

      - name: Install dependencies (yarn)
        if: ${{ hashFiles('pnpm-lock.yaml') == '' && hashFiles('yarn.lock') != '' }}
        run: yarn install --frozen-lockfile

      - name: Install dependencies (npm)
        if: ${{ hashFiles('pnpm-lock.yaml') == '' && hashFiles('yarn.lock') == '' }}
        run: npm ci

      # Allure CLI needs Java; Temurin 17 is the safe default
      - name: Setup Java for Allure
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # Install specific Allure CLI version from GitHub releases
      - name: Install Allure CLI ${{ inputs.allure_version }}
        run: |
          set -eux
          curl -L -o allure.tgz "https://github.com/allure-framework/allure2/releases/download/${{ inputs.allure_version }}/allure-${{ inputs.allure_version }}.tgz"
          sudo tar -C /opt -xzf allure.tgz
          sudo mv "/opt/allure-${{ inputs.allure_version }}" /opt/allure
          sudo ln -sf /opt/allure/bin/allure /usr/local/bin/allure
          allure --version

      # Create test directories
      - name: Setup test directories
        run: mkdir -p "$ALLURE_RESULTS_DIR" "$ALLURE_REPORT_DIR"

      # Run tests
      - name: Run tests
        id: tests
        shell: bash
        continue-on-error: true
        run: |
          set +e
          
          # Determine package manager
          if [ -f pnpm-lock.yaml ]; then PM="pnpm"; elif [ -f yarn.lock ]; then PM="yarn"; else PM="npm"; fi
          
          # If repo provides run-tests.sh, use it for consistency with local runs
          if [ -x ./run-tests.sh ]; then
            ./run-tests.sh
          else
            # Fallback: direct npm script invocation
            $PM run "$TEST_SCRIPT"
          fi
          
          CODE=$?
          echo "exit_code=$CODE" >> $GITHUB_OUTPUT
          exit 0

      # Generate Allure report
      - name: Generate Allure report
        if: always()
        shell: bash
        run: |
          set -eux
          if [ -d "$ALLURE_RESULTS_DIR" ] && [ "$(ls -A $ALLURE_RESULTS_DIR)" ]; then
            allure generate "$ALLURE_RESULTS_DIR" --clean -o "$ALLURE_REPORT_DIR"
          else
            echo "No Allure results found, creating empty report directory"
            mkdir -p "$ALLURE_REPORT_DIR"
            echo "<html><body><h1>No test results available</h1></body></html>" > "$ALLURE_REPORT_DIR/index.html"
          fi

      # Upload Allure report (HTML)
      - name: Upload Allure report (HTML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ matrix.node }}
          path: ${{ env.ALLURE_REPORT_DIR }}
          if-no-files-found: ignore
          retention-days: 30

      # Job summary
      - name: Job Summary
        if: always()
        shell: bash
        run: |
          echo "## Test & Allure Summary (Node ${{ matrix.node }})" >> $GITHUB_STEP_SUMMARY
          echo "- Node.js: \`${{ matrix.node }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Test script: \`${{ inputs.test_script }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Test exit code: \`${{ steps.tests.outputs.exit_code || 'N/A' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Allure version: \`${{ inputs.allure_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "${{ env.ALLURE_REPORT_DIR }}/widgets/summary.json" ]; then
            sudo apt-get update -y >/dev/null 2>&1 || true
            sudo apt-get install -y jq >/dev/null 2>&1 || true
            P=$(jq '.statistic.passed' ${{ env.ALLURE_REPORT_DIR }}/widgets/summary.json 2>/dev/null || echo 0)
            F=$(jq '.statistic.failed' ${{ env.ALLURE_REPORT_DIR }}/widgets/summary.json 2>/dev/null || echo 0)
            B=$(jq '.statistic.broken' ${{ env.ALLURE_REPORT_DIR }}/widgets/summary.json 2>/dev/null || echo 0)
            S=$(jq '.statistic.skipped' ${{ env.ALLURE_REPORT_DIR }}/widgets/summary.json 2>/dev/null || echo 0)
            T=$(jq '.statistic.total'  ${{ env.ALLURE_REPORT_DIR }}/widgets/summary.json 2>/dev/null || echo 0)
            echo "### Test Results" >> $GITHUB_STEP_SUMMARY
            echo "- Total: **$T**  |  Passed: **$P**  |  Failed: **$F**  |  Broken: **$B**  |  Skipped: **$S**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Allure summary not found (no results?)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- \`allure-report-${{ matrix.node }}\` - Allure HTML report" >> $GITHUB_STEP_SUMMARY

      # Fail job if tests failed
      - name: Check test results
        if: always()
        shell: bash
        run: |
          if [ "${{ steps.tests.outputs.exit_code }}" != "0" ]; then
            echo "❌ Tests failed with exit code: ${{ steps.tests.outputs.exit_code }}"
            exit 1
          fi
          echo "✅ All tests passed"
